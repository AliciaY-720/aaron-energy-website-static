---
import MainLayout from "@src/layouts/MainLayout.astro";
import { Icon } from "astro-icon/components";
import { getCollection } from "astro:content";
import type { GetStaticPaths } from "astro";

export const getStaticPaths = (async () => {
  const services = await getCollection("service");
  return services.map((service) => ({
    params: { slug: service.slug },
    props: { service },
  }));
}) satisfies GetStaticPaths;

const { service } = Astro.props;
const { Content } = await service.render();
const data = service.data;
---

<MainLayout title={`${data.title} – Constructors Services`}>
  <!-- HeadingDetail -->
  <section class="relative py-16 lg:py-20 overflow-hidden">
    <div class="absolute inset-0">
      <img 
        src={data.cover} 
        alt={data.title} 
        class="w-full h-full object-cover"
      />
      <div class="absolute inset-0 bg-linear-to-r from-black/95 via-black/80 to-black/60"></div>
    </div>
    <div class="relative z-10 max-w-3xl mx-auto px-4 text-center text-white">
      <span class="inline-block bg-primary text-white px-6 py-2 rounded-full font-bold mb-6">
        {data.label}
      </span>
      <h1 class="font-display text-5xl md:text-6xl font-bold leading-tight mb-6">
        {data.title}
      </h1>
      <div class="inline-flex h-1 warning-stripes w-40 mx-auto mb-8"></div>
      <p class="text-xl md:text-2xl text-gray-200 max-w-4xl mx-auto">
        {data.description}
      </p>
    </div>
  </section>

  <!-- Overview -->
  <section class="py-20 bg-white">
    <div class="max-w-7xl mx-auto px-4">
      <div class="grid lg:grid-cols-2 gap-16 items-center">
        <div>
          <img 
            src={data.preview.image} 
            alt={data.preview.title}
            class="rounded-2xl shadow-2xl"
          />
        </div>
        <div>
          <h2 class="font-display text-4xl md:text-5xl text-dark mb-6">
            {data.preview.title}
          </h2>
          <p class="text-lg text-steel-gray mb-8">
            {data.preview.description}
          </p>
          <ul class="space-y-5 text-lg text-dark">
            {data.benefits.map((benefit) => (
              <li class="flex items-start gap-4">
                <Icon 
                  name="bi:check-circle-fill" 
                  class="text-2xl text-primary mt-0.5 shrink-0"
                />
                <span>{benefit}</span>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- What's Included -->
  <section class="py-20 bg-bg-soft">
    <div class="max-w-7xl mx-auto px-4">
      <div class="grid lg:grid-cols-3 gap-12">
        <!-- Left Column - Overview -->
        <div class="lg:col-span-2">
           <h2 class="font-display text-3xl md:text-4xl text-dark mb-6">
            Service Overview
           </h2>
           <div class="post-content">
                <Content />
            </div>

            <p class="text-sm text-steel-gray">
              gallery images: {data.gallery?.images?.length ?? 0}
            </p>

            {data.gallery && (
              <section class="mt-12">
                <h3 class="font-display text-3xl text-dark mb-4">
                  {data.gallery.title}
                </h3>

                {data.gallery.description && (
                  <p class="text-lg text-steel-gray mb-8">
                    {data.gallery.description}
                  </p>
                )}

                {/* ✅ Grid */}
                <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
                  {data.gallery.images.map((img) => (
                    <button
                      type="button"
                      class="text-left bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-2xl transition focus:outline-none focus:ring-2 focus:ring-primary"
                      data-gallery-thumb
                      data-src={img.src}
                      data-alt={img.alt ?? ""}
                    >
                      <img
                        src={img.src}
                        alt={img.alt ?? ""}
                        class="w-full h-56 object-cover"
                        loading="lazy"
                      />
                      {img.alt && (
                        <div class="p-4 text-steel-gray text-sm">
                          {img.alt}
                        </div>
                      )}
                    </button>
                  ))}
                </div>

                {/* ✅ Modal */}
                <dialog
                  id="galleryModal"
                  class="backdrop:bg-black/80 p-0 rounded-2xl w-[min(92vw,1000px)]"
                >
                  <div class="bg-white rounded-2xl overflow-hidden">
                    <div class="flex items-center justify-between px-4 py-3 border-b">
                      <p id="galleryCaption" class="text-sm text-steel-gray pr-4"></p>
                      <button
                        type="button"
                        class="px-3 py-2 rounded-lg hover:bg-gray-100 transition"
                        data-close
                        aria-label="Close"
                      >
                        ✕
                      </button>
                    </div>

                    <div class="bg-black flex items-center justify-center">
                      <img
                        id="galleryFullImg"
                        src=""
                        alt=""
                        class="max-h-[80vh] w-auto object-contain"
                        loading="eager"
                      />
                    </div>
                  </div>
                </dialog>

                {/* ✅ Script: click to open + Esc/background close */}
                <script is:inline>
                  const modal = document.getElementById("galleryModal");
                  const fullImg = document.getElementById("galleryFullImg");
                  const caption = document.getElementById("galleryCaption");

                  function openModal(src, alt) {
                    fullImg.src = src;
                    fullImg.alt = alt || "";
                    caption.textContent = alt || "";
                    modal.showModal();
                    document.body.style.overflow = "hidden";
                  }

                  function closeModal() {
                    modal.close();
                    fullImg.src = "";
                    fullImg.alt = "";
                    caption.textContent = "";
                    document.body.style.overflow = "";
                  }

                  document.querySelectorAll("[data-gallery-thumb]").forEach((btn) => {
                    btn.addEventListener("click", () => {
                      const src = btn.getAttribute("data-src");
                      const alt = btn.getAttribute("data-alt") || "";
                      openModal(src, alt);
                    });
                  });

                  modal.addEventListener("click", (e) => {
                    // 点击 dialog 的空白处关闭（不是点图片/内容）
                    const rect = modal.getBoundingClientRect();
                    const clickedInDialog =
                      e.clientX >= rect.left &&
                      e.clientX <= rect.right &&
                      e.clientY >= rect.top &&
                      e.clientY <= rect.bottom;
                    if (!clickedInDialog) closeModal();
                  });

                  modal.querySelector("[data-close]").addEventListener("click", closeModal);

                  modal.addEventListener("close", () => {
                    document.body.style.overflow = "";
                  });
                </script>
              </section>
            )}

        </div>

        <!-- Right Column - Service Info -->
        <div>
          <div class="bg-white rounded-2xl shadow-2xl p-8 sticky top-24">
            <h3 class="font-display text-3xl text-dark mb-8">
              Service Information
            </h3>
            <div class="space-y-6 text-lg">
              {data.serviceInfo.map((info) => (
                <div>
                  <span class="font-semibold text-dark block mb-1">
                    {info.label}
                  </span>
                  <p class="text-steel-gray">
                    {info.description}
                  </p>
                </div>
              ))}
            </div>

            <a 
              href={data.cta.link}
              class="mt-10 w-full bg-primary hover:bg-amber-600 text-white font-bold py-4 rounded-lg flex items-center justify-center gap-3 transition"
            >
              <Icon name="bi:send" class="text-xl" />
              {data.cta.text}
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>
</MainLayout>